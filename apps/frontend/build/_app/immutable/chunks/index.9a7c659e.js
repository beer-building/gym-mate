import{y as F,p as _,u as m,x as u,j as V,n as C,c as Z,m as L,T as me}from"./http-service.b939156e.js";const ee={isData:e=>!0,getErrorMessages:()=>[]};function A(){return A=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},A.apply(this,arguments)}function te(e,t){if(e==null)return{};var r={},o=Object.keys(e),a,l;for(l=0;l<o.length;l++)a=o[l],!(t.indexOf(a)>=0)&&(r[a]=e[a]);return r}function he(){const e={resolve:()=>{},reject:()=>{},promise:null};return e.promise=new Promise((t,r)=>{e.resolve=t,e.reject=r}),e.promise.catch(()=>{}),e}function Q(e,t){try{if(e===t||Number.isNaN(e)&&Number.isNaN(t))return!0;const r=J(e),o=J(t);if(r!==o)return!1;if(r==="pure-object"){if(e===t)return!0;const a=Object.keys(e),l=Object.keys(t).length;if(a.length!==l)return!1;for(let s=0,d=a.length;s<d;s++){const g=a[s];if(!Object.prototype.hasOwnProperty.call(t,a[s]))return!1;const k=e[g],y=t[g];if(k===e||y===t||k===t||y===e)return k===y;if(!Q(k,y))return!1}return!0}else if(r==="array"){if(e.length===t.length)for(let a=0;a<e.length;a++){const l=e[a],s=t[a];if(l===e||s===t||l===t||s===e)return l===s;if(!Q(l,s))return!1}else return!1;return!0}else if(r==="object"&&e.valueOf&&t.valueOf)return e.valueOf()===t.valueOf()}catch{}return!1}function ve(e){if(Array.isArray(e))return!0;const t=e.length;return typeof t=="number"&&t>-1?t?0 in e&&t-1 in e:!0:!1}function J(e){const t=typeof e;return t==="object"?e===null?"null":ve(e)?"array":e.constructor===Object||Object.getPrototypeOf(e)===null?"pure-object":"object":t}function U(e){return t=>t[e]}const ge="INVALID_DATA",re="ABORT",ye="HTTP",$e="NETWORK";function ne(e){return A({},e,{errorType:ge,explanation:"Response was considered as invalid against a given contract"})}function _e(){return{errorType:re,explanation:"Request was cancelled due to concurrency policy"}}function ke(e){return A({},e,{errorType:ye,explanation:"Request was finished with unsuccessful HTTP code"})}function be(e){return A({},e,{errorType:$e,explanation:"Request was failed due to network problems"})}function X({field:e}){let t;if(e===void 0)t=_(r=>null,{serialize:"ignore"});else if(C.store(e))t=L(e,o=>a=>o??null);else if(e!=null&&e.source&&(e!=null&&e.fn)){const r=e;t=L(r.source,o=>a=>{var l;return(l=r.fn(a,o))!==null&&l!==void 0?l:null})}else if(typeof e=="function"){const r=e;t=_(o=>{var a;return(a=r(o))!==null&&a!==void 0?a:null},{serialize:"ignore"})}else{const r=e;t=_(o=>r??null,{serialize:"ignore"})}return t}function xe(e){return e?C.store(e)?e:_(e,{serialize:"ignore"}):_(null,{serialize:"ignore"})}function Pe(e,t){let r=[],o=()=>!1;Array.isArray(e)?(r=e,o=t):Array.isArray(e.stores)&&(r=e.stores,o=e.predicate);let a;we(o)?a=o:C.store(o)?a=o.map(d=>g=>d===g):a=d=>d===o;const l=L(r);return L(a,l,(d,g)=>g.every(d))}function we(e){return typeof e=="function"}function W(e){return e.map(t=>!t)}function Ae(...e){return Pe({predicate:!0,stores:e})}function De({clock:e,until:t}){const r=m(),o=_(!1,{serialize:"ignore"}).on(r,()=>!0).on(e,()=>!1);return u({clock:[e,t],source:e,filter:Ae(t,W(o)),target:r}),r}function q(e){if(e==="ignore")return"ignore"}F(()=>Date.now());function f(e){return e.map(t=>t)}function Ee(e){return F({handler:({result:r})=>{if(!e.isData(r))throw ne({validationErrors:e.getErrorMessages(r),response:r});return r},sid:"ff.applyContractFx"})}function Fe(e){return!!(e===!0||Array.isArray(e)&&e.length===0||typeof e=="string"&&e.length===0)}function je(e){return e===!0?[]:e===!1?["Invalid data"]:Array.isArray(e)?e.length===0?[]:e:[e]}const Se=()=>!0;function Te(e){var t;return((t=e.error)===null||t===void 0?void 0:t.errorType)===re}function Oe(e){const t=m(e.shortName+".internalCall"),r=me.compute({fn:a=>{const l=a.handler,s=Re(l,t);return a.handler=s,a}});return Ie(e).seq.splice(1,0,r),t}function Re(e,t){function r(...o){const a=e(...o);if(a instanceof Promise){const l=he(),s=Y(l);return t(s),a.then(l.resolve,l.reject),l.promise}else{const l=Y();return t(l),a}}return r}function Y(e){let t=e?"pending":"finished";function r(){t="finished",o.status=t}e&&e.promise.then(r,r);const o={id:Ne(),status:t,abort:(a=_e())=>{t!=="finished"&&e&&e.reject(a)},promise:e==null?void 0:e.promise};return o}function Ie(e){return e.graphite.scope.runner}let ze=0;function Ne(){return`${ze++}`}function ae({name:e,meta:t,kind:r,serialize:o,enabled:a,contract:l,validate:s,mapData:d,sourced:g,paramsAreMeaningless:k}){const y=m(),i=m(),S=m(),x=m(),$=Ee(l),h=e??"unnamed",P=F({handler:()=>{throw new Error("Not implemented")},sid:`ff.${h}.executeFx`,name:`${h}.executeFx`}),H=Oe(P),z=[{name:"remote_source",get:F(async({params:n})=>({result:await P(n),stale:!1}))}],{retrieveDataFx:j,notifyAboutNewValidDataFx:B,notifyAboutDataInvalidationFx:N}=Le(z),T=m(),v=m();u({clock:T,fn:n=>({params:n,meta:{stopErrorPropagation:!1,stale:!0}}),target:x});const p={success:m(),failure:m(),skip:m(),finally:m()},b=m(),O=m();V({source:b,match:{aborted:({error:n})=>Te({error:n})},cases:{aborted:O,__:p.failure}});const D=_("initial",{sid:`ff.${h}.$status`,name:`${h}.$status`,serialize:o}),R=_([],{serialize:"ignore"});u({clock:D.updates,source:R,fn:(n,c)=>[...n,c],target:R});const E=xe(a??!0).map(Boolean),K=_(null,{serialize:"ignore"}),le=D.map(n=>n==="initial"),ce=D.map(n=>n==="pending"),ue=D.map(n=>n==="fail"),fe=D.map(n=>n==="done"),de=D.map(n=>["fail","done"].includes(n));u({clock:[j.map(()=>"pending"),p.success.map(()=>"done"),p.failure.map(()=>"fail"),u({clock:O,source:R,fn:n=>{var c;return(c=n[n.length-2])!==null&&c!==void 0?c:"initial"}})],target:D}),u({clock:x,filter:E,fn:({params:n})=>n,target:K}),u({clock:T,filter:W(E),fn(n){return{params:n,meta:{stopErrorPropagation:!1,stale:!1}}},target:p.skip}),u({clock:y,fn:({params:n})=>({params:n,meta:{stopErrorPropagation:!1,stale:!0}}),target:N}),u({clock:N.finally,source:y,filter:({refresh:n})=>n,fn:({params:n})=>({params:n,meta:{stopErrorPropagation:!1,stale:!0}}),target:x}),u({clock:x,filter:E,target:j}),u({clock:j,target:v}),u({clock:j.done,fn:({params:n,result:c})=>({params:n.params,result:c.result,meta:{stopErrorPropagation:!1,stale:c.stale}}),filter:E,target:$}),u({clock:j.fail,source:E,filter:(n,{error:c})=>n&&!c.stopErrorPropagation,fn:(n,{error:c,params:w})=>({error:c.error,params:w.params,meta:{stopErrorPropagation:c.stopErrorPropagation,stale:!1}}),target:b});const{validDataRecieved:G,__:pe}=V(u({clock:$.done,source:{partialValidator:X({field:s??Se})},fn:({partialValidator:n},{params:{params:c,meta:w},result:I})=>({result:I,params:c,validation:n({result:I,params:c}),meta:w})}),{validDataRecieved:({validation:n})=>Fe(n)});return u({clock:G,source:{partialMapper:X({field:d})},fn:({partialMapper:n},{params:c,result:w,meta:I})=>({result:n({params:c,result:w}),params:c,meta:I}),target:p.success}),u({clock:p.success,filter:({meta:n})=>n.stale,fn:({params:n,meta:c})=>({params:n,meta:c,skipStale:!0}),target:j}),u({clock:G,filter:({meta:n})=>!n.stale,target:B}),u({clock:$.fail,filter:({params:n})=>!n.meta.stopErrorPropagation,fn:({error:n,params:c})=>({error:n,params:c.params,meta:c.meta}),target:b}),u({clock:pe,filter:({meta:n})=>!n.stopErrorPropagation,fn:({params:n,validation:c,meta:w,result:I})=>({params:n,error:ne({validationErrors:je(c),response:I}),meta:w}),target:b}),u({clock:E.updates,source:T,filter:W(E),fn:n=>({params:n,meta:{stopErrorPropagation:!1,stale:!0}}),target:p.skip}),u({clock:p.success,fn:({params:n,result:c,meta:w})=>({status:"done",params:n,result:c,meta:w}),target:p.finally}),u({clock:p.failure,fn:({params:n,error:c,meta:w})=>({status:"fail",params:n,error:c,meta:w}),target:p.finally}),u({clock:p.skip,fn:({params:n,meta:c})=>({status:"skip",params:n,meta:c}),target:p.finally}),{start:T,finished:p,started:v,aborted:O,$status:D,$idle:le,$pending:ce,$failed:ue,$succeeded:fe,$finished:de,$enabled:E,__:{executeFx:P,meta:A({},t,{name:h}),kind:r,$latestParams:f(K),lowLevelAPI:{dataSources:z,dataSourceRetrieverFx:j,sourced:g??[],paramsAreMeaningless:k??!1,revalidate:y,pushError:S,pushData:i,startWithMeta:x,callObjectCreated:H}}}}function Le(e){const t=F({handler:async({params:a,skipStale:l})=>{for(const s of e)try{const d=await s.get({params:a});if(l&&(d!=null&&d.stale))continue;if(d)return d}catch(d){throw{stopErrorPropagation:!1,error:d}}throw{stopErrorPropagation:!1,error:new Error("No data source returned data")}}}),r=F({handler:async({params:a,result:l})=>{await Promise.all(e.map(U("set")).filter(Boolean).map(s=>s({params:a,result:l})))}}),o=F({handler:async({params:a})=>{await Promise.all(e.map(U("unset")).filter(Boolean).map(l=>l({params:a})))}});return{retrieveDataFx:t,notifyAboutNewValidDataFx:r,notifyAboutDataInvalidationFx:o}}const Ce=Symbol("Query"),He=["params"];function oe(e){const{initialData:t,contract:r,mapData:o,enabled:a,validate:l,name:s,serialize:d,sourced:g,paramsAreMeaningless:k}=e,y=t??null,i=ae({name:s,kind:Ce,serialize:q(d),enabled:a,meta:{serialize:d,initialData:y,sid:Me(_(null,{sid:"dummy"}))},contract:r,validate:l,mapData:o,sourced:g,paramsAreMeaningless:k}),S=m(),x=m(),$=_(y,{sid:`ff.${i.__.meta.name}.$data`,name:`${i.__.meta.name}.$data`,serialize:d}),h=_(null,{sid:`ff.${i.__.meta.name}.$error`,name:`${i.__.meta.name}.$error`,serialize:q(d)}),P=_(!0,{sid:`ff.${i.__.meta.name}.$stale`,name:`${i.__.meta.name}.$stale`,serialize:q(d)});u({clock:i.finished.success,fn:()=>null,target:h}),u({clock:i.finished.success,fn:({result:v})=>v,target:$}),$.reset(i.finished.failure),u({clock:i.finished.failure,fn:({error:v})=>v,target:h}),u({clock:i.finished.finally,fn:({meta:v})=>v.stale,target:P}),u({clock:i.__.lowLevelAPI.pushData,target:[$,h.reinit]}),u({clock:i.__.lowLevelAPI.pushError,target:[h,$.reinit]});const H=De({clock:S,until:i.$enabled}),M=m(),{haveToStart:z,__:j}=V(u({clock:H,source:{stale:P,latestParams:i.__.$latestParams},fn:({stale:v,latestParams:p},b)=>({haveToStart:v||!Q(b??null,p),params:b})}),{haveToStart:({haveToStart:v})=>v});u({clock:j,fn:()=>null,target:M}),u({clock:z,fn:({params:v})=>v,target:i.start}),u({clock:x,target:[$.reinit,h.reinit,P.reinit,i.$status.reinit]});const B={data:$,error:h,stale:P,pending:i.$pending,start:i.start},N=()=>B,T=({source:v,mapParams:p})=>{const b=oe(e);return b.__.lowLevelAPI.dataSourceRetrieverFx.use(Z({source:v,mapParams:(O,D)=>{let{params:R}=O,E=te(O,He);return A({params:p?p(R,D):R},E)},effect:i.__.lowLevelAPI.dataSourceRetrieverFx})),b};return{reset:x,refresh:S,start:i.start,started:f(i.started),$data:f($),$error:f(h),$status:f(i.$status),$idle:f(i.$idle),$pending:f(i.$pending),$succeeded:f(i.$succeeded),$failed:f(i.$failed),$finished:f(i.$finished),$enabled:f(i.$enabled),$stale:P,aborted:f(i.aborted),finished:{success:f(i.finished.success),failure:f(i.finished.failure),finally:f(i.finished.finally),skip:f(i.finished.skip)},__:A({},i.__,{lowLevelAPI:A({},i.__.lowLevelAPI,{refreshSkipDueToFreshness:M}),experimentalAPI:{attach:T}}),"@@unitShape":N}}function Me(e){const t=e.sid;return t!=null&&t.includes("|")?t:null}function se(e){const t=e;if(C.effect(t.effect))return t.effect;if(typeof t.handler=="function")return F(t.handler);throw new Be("handler or effect must be passed to the config")}class Be extends Error{constructor(t){super(t)}}function Ke(e){var t,r,o;const a=oe({initialData:(t=e.initialData)!==null&&t!==void 0?t:null,contract:(r=e.contract)!==null&&r!==void 0?r:ee,mapData:(o=e.mapData)!==null&&o!==void 0?o:({result:l})=>l,enabled:e.enabled,validate:e.validate,name:e.name,serialize:e.serialize});return a.__.executeFx.use(se(e)),a}const qe=F({sid:"ff.fetchFx",handler:globalThis.fetch});F({handler:async e=>{var t;const r=await qe(e).catch(o=>{var a;throw be({reason:(a=o==null?void 0:o.message)!==null&&a!==void 0?a:null,cause:o})});if(!r.ok)throw ke({status:r.status,statusText:r.statusText,response:(t=await r.text().catch(()=>null))!==null&&t!==void 0?t:null});return r},sid:"ff.requestFx"});const Ve=Symbol("Mutation"),Qe=["params"];function ie(e){const{name:t,enabled:r,contract:o,validate:a,mapData:l}=e,s=ae({name:t,serialize:"ignore",enabled:r,kind:Ve,meta:null,contract:o,validate:a,mapData:l}),d={pending:s.$pending,start:s.start},g=()=>d,k=({source:y,mapParams:i})=>{const S=ie(e);return S.__.lowLevelAPI.dataSourceRetrieverFx.use(Z({source:y,mapParams:(x,$)=>{let{params:h}=x,P=te(x,Qe);return A({params:i?i(h,$):h},P)},effect:s.__.lowLevelAPI.dataSourceRetrieverFx})),S};return{start:s.start,started:f(s.started),aborted:f(s.aborted),$status:f(s.$status),$idle:f(s.$idle),$pending:f(s.$pending),$succeeded:f(s.$succeeded),$failed:f(s.$failed),$finished:f(s.$finished),$enabled:f(s.$enabled),finished:{success:f(s.finished.success),failure:f(s.finished.failure),finally:f(s.finished.finally),skip:f(s.finished.skip)},__:A({},s.__,{experimentalAPI:{attach:k}}),"@@unitShape":g}}function Ge(e){var t;const r=ie({name:e.name,enabled:e.enabled,contract:(t=e.contract)!==null&&t!==void 0?t:ee,mapData:({result:o})=>o});return r.__.executeFx.use(se(e)),r}export{Ge as a,Ke as c};
